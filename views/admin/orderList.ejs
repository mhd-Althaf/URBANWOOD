<%-include("../../views/partials/admin/header")%>

  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
    <style>
 .swal-title {
  color: black !important;
}

.swal-content {
  color: black !important;
}

    </style>
  </head>
  <div class="content-header">
    <h2 class="content-title card-title">Order List</h2>
  </div>
  <header class="card-header text-center mb-20">
    <!-- <form action="" method="get" class="d-inline">
        <div class="input-group input-group-sm border border-1 border-grey rounded-pill" style="width: 500px; margin-left: 230px;">
            <input type="text" class="form-control border-0 rounded-pill" placeholder="Search orders or customers" name="search">
            <button class="btn border-0" type="submit">Search</button>
        </div>
    </form> -->
  </header>
  <div class="right mt-5">
    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col"><b>Order ID</b></th>
          <th scope="col"><b>Customer Name</b></th>
          <th scope="col"><b>Total Price</b></th>
          <th scope="col"><b>Status</b></th>
          <th scope="col"><b>Payment Method</b></th>
          <th scope="col"><b>Action</b></th>
          <th scope="col"><b>Edit</b></th>
        </tr>
      </thead>
      <tbody>
        <% for (let i=0; i < orders.length; i++) { %>
          <tr>
            <td>
              <%= orders[i].orderId %>
            </td>
            <td>
              <% if (orders[i].userId) { %>
                <%= orders[i].userId.name %>
                  <% } else { %>
                    N/A
                    <% } %>
            </td>
            <td>‚Çπ<%= orders[i].finalAmount.toFixed(2) %>
            </td>
            <td>
              <%= orders[i].status %>
            </td>
            <td>
              <%= orders[i].paymentMethod.toUpperCase() %>
            </td>
            <td>
                <% if (orders[i].status === "Pending") { %>
                  <button class="btn btn-success" onclick="changeOrderStatus('<%= orders[i].orderId %>', 'Processing')" style="width: 120px;">
                    Processing
                  </button>
                <% } else if (orders[i].status === "Processing") { %>
                  <button class="btn btn-warning" onclick="changeOrderStatus('<%= orders[i].orderId %>', 'Shipped')" style="width: 120px;">
                   Shipped
                  </button>
                <% } else if (orders[i].status === "Shipped") { %>
                  <button class="btn btn-primary" onclick="changeOrderStatus('<%= orders[i].orderId %>', 'Delivered')" style="width: 120px;">
                   Delivered
                  </button>
                <% } else { %>
                  <span class="text-success">Delivered</span>
                <% } %>
              </td>
              
            <td>
              <button class="btn btn-info" style="width: 80px;">
                <a href="/admin/orderDetailsAdmin?orderId=<%= orders[i].orderId %>" class="btn btn-info text-white" style="width: 80px; text-decoration: none;">
                  View
                </a>
              </button>
            </td>
          </tr>
          <% } %>
      </tbody>

  </div>
  <div class="container mt-3">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mb-20" style="margin-right: 200px;">
        <% for (let i=1; i <=totalPages; i++) { %>
          <li class="page-item <%= (i === currentPage) ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>">
              <%= i %>
            </a>
          </li>
          <% } %>
      </ul>
    </nav>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script>
function changeOrderStatus(orderId, newStatus) {
  Swal.fire({
    title: `<span style="color: black;">Change Status to "${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}"?</span>`,
    html: `<span style="color: black;">Are you sure you want to update this order's status?</span>`,
    icon: "question",
    iconHtml: "üîÑ", 
    showCancelButton: true,
    confirmButtonColor: "#28a745", 
    cancelButtonColor: "#d33", 
    confirmButtonText: "Yes, Update!",
    cancelButtonText: "Cancel",
    background: "#f9f9f9", 
    backdrop: `rgba(0, 0, 0, 0.4)`, 
    showLoaderOnConfirm: true, 
    preConfirm: () => {
      return $.ajax({
        url: `/admin/changeStatus/${orderId}`,
        method: "PATCH",
        contentType: "application/json",
        data: JSON.stringify({ status: newStatus })
      })
        .then((response) => {
          if (response.status) {
            Swal.fire({
              title: `<span style="color: black;">‚úÖ Status Updated!</span>`,
              html: `<span style="color: black;">Order status changed to "${newStatus}".</span>`,
              icon: "success",
              confirmButtonColor: "#28a745",
              timer: 2000,
              timerProgressBar: true,
              willClose: () => {
                location.reload();
              }
            });
          } else {
            throw new Error(response.message || "Failed to update order status.");
          }
        })
        .catch((error) => {
          Swal.fire({
            title: `<span style="color: black;">‚ùå Update Failed!</span>`,
            html: `<span style="color: black;">${error.message}</span>`,
            icon: "error",
            confirmButtonColor: "#d33"
          });
        });
    }
  });
}


  </script>